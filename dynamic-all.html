<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Plots for Autolab</title>
    <script language="javascript" type="text/javascript" src="./flot/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="./flot/jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="dynamic.js"></script>
 </head>
	<body>
	<h3 id="title" align="center">Plots for all robots</h3>
	<table border="0" style="width:100%;height:100%;">
		<tr>
			<td><div id="placeholder0" style="width:1300px;height:220px;"></div></td>
			<td style="width:100px">
				<a href="dynamic-robot.html?robot=cb01">cb01</a>
				<p id="0v">voltage: </p>
				<p id="0c">current: </p>
				<p id="0s">speed: </p>
			</td>
		</tr>
		<tr>
			<td><div id="placeholder1" style="width:1300px;height:220px;"></div></td>
			<td style="width:100px">
				<a href="dynamic-robot.html?robot=cb02">cb02</a>
				<p id="1v">voltage: </p>
				<p id="1c">current: </p>
				<p id="1s">speed: </p>
			</td>
		</tr>
		<tr>
			<td><div id="placeholder2" style="width:1300px;height:220px;"></div></td>
			<td>
				<a href="dynamic-robot.html?robot=Pioneer01">Pioneer01</a>
				<p id="2v">voltage: </p>
				<p id="2c">current: </p>
				<p id="2s">speed: </p>
			</td>
		</tr>
		<tr>
			<td><div id="placeholdert" style="width:800px;height:600px;"></div></td>
			<td>
				<p>cb01</p>
				<p id="0x">x</p>
				<p id="0y">y</p>
				<p>cb02</p>
				<p id="1x">x</p>
				<p id="1y">y</p>
			</td>
		</tr>
	</table>
	<p id="debug">debug: </p>
<script type="text/javascript">
// by fzhan@Autolab
// dynamic figures for all the robots and trajectories.
$(function () {
    var totalPoints = 300, plotNum = 3, trajLen = 20, trajPlotNum = 2;
    var labels = ["voltage", "current", "speed"];
    var robotName = ["cb01", "cb02", "pioneer01"];
    var dataset = {
		"0v": {label: labels[0], data: []},
		"0c": {label: labels[1], data: []},
		"0s": {label: labels[2], data: []},
		"1v": {label: labels[0], data: []},
		"1c": {label: labels[1], data: []},
		"1s": {label: labels[2], data: []},
		"2v": {label: labels[0], data: []},
		"2c": {label: labels[1], data: []},
		"2s": {label: labels[2], data: []},
		"3v": {label: labels[0], data: []},
		"3c": {label: labels[1], data: []},
		"3s": {label: labels[2], data: []},
		"0x": {label: robotName[0], data: []},
		"0y": {label: robotName[0], data: []},
		"1x": {label: robotName[1], data: []},
		"1y": {label: robotName[1], data: []}, }
    var redis_ret = 0, data_ret = [];
    for (var i = 0; i  < plotNum * 3 + trajPlotNum * 2; ++ i)
	{
		data_ret.push(0);
	}
	// connect to Redis to retrieve data asynchronously
	function connectRedis()
	{
		var xmlhttp;
		if (window.XMLHttpRequest)
		{// code for IE7+, Firefox, Chrome, Opera, Safari
			xmlhttp=new XMLHttpRequest();
		}
		else
		{// code for IE6, IE5
			xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
		}
		xmlhttp.onreadystatechange=function()
		{
			if (xmlhttp.readyState==4 && xmlhttp.status==200)
			{
				var ret = xmlhttp.responseText.split(" ");
				for (var i = 0; i < ret.length; ++ i)
				{
					data_ret[i] = parseFloat(ret[i]);
				}
				document.getElementById("debug").innerHTML = 'debug: ' + pos;
			}
		}
		xmlhttp.open("GET","connectRedis.php",true);
		xmlhttp.send();
	}
	// get data from connectRedis().
    function getData(label) {
		if (dataset[label] == undefined)
			return [0, 0];
        if (dataset[label].data.length > 0)
            dataset[label].data = dataset[label].data.slice(1);
        while (dataset[label].data.length < totalPoints)
        {
            var prev = dataset[label].data.length > 0 ? dataset[label].data[dataset[label].data.length - 1] : 0;
            //var y = prev + Math.random() * 10 - 5;
            connectRedis();
            // get the corresponding order of that plot
            var pos = 0;
            switch (label[1])
            {
				case 'v':
				pos = 0;
				break;
				case 'c':
				pos = 1;
				break;
				case 's':
				pos = 2;
				break;
				case 'x':
				pos = 3;
				break;
				case 'y':
				pos = 4;
				break;
			}
			pos = pos + parseInt(label[0]) * 5;
            var y = prev + data_ret[pos] * 10 - 5;
            if (y < 0)
                y = 0;
            if (y > 100)
                y = 100;
            dataset[label].data.push(y);
        }
        // add the number to the corresponding label
        if ((label[0] == "0" || label[0] == "1" || label[0] == "2") && (label[1] == "v" || label[1] == "c" || label[1] == "s"))
		{
			document.getElementById(label).innerHTML = dataset[label].label + ": " + Math.round(y);
		}
        if ((label[0] == "0" || label[0] == "1") && (label[1] == "x" || label[1] == "y"))
		{
			document.getElementById(label).innerHTML = label[1] + ": " + Math.round(y);
		}
        // zip the generated y values with the x values
        var res = [];
        for (var i = 0; i < dataset[label].data.length; ++ i)
            res.push([i + 1 - dataset[label].data.length, dataset[label].data[i]])
        return res;
    }
    var options = {
		// drawing is faster without shadows
        series: {shadowSize: 0, lines: {show: true} },
        yaxis: { min: 0, max: 100 },
        xaxis: { min: -totalPoints + 1, max: 0},
		grid: {show: true},
    };
    // plot an array of plots
    var plot = new Array();
    for (var i = 0; i < plotNum; ++ i)
    {
		var data = [{label: dataset[i+"v"].label, data: getData(i+"v")},
		{label: dataset[i+"c"].label, data: getData(i+"c")},
		{label: dataset[i+"s"].label, data: getData(i+"s")} ];
		plot[i] = $.plot($("#placeholder"+i), data, options);
	}
	// get the data of the trajectories
	var res = new Array();
	for (var i = 0; i < trajPlotNum; ++ i)
	{
		getData(i+"x");
		getData(i+"y");
		var len = dataset[i+"y"].data.length > dataset[i+"x"].data.length ? dataset[i+"x"].data.length : dataset[i+"y"].data.length;
		var init = len > trajLen ? len - trajLen : 0;
		res[i] = [];
		for (var j = init; j < len; ++ j)
			res[i].push([dataset[i+"x"].data[j], dataset[i+"y"].data[j]]);
	}
	var data = [{label: dataset["0y"].label, data: res[0]},
	{label: dataset["1y"].label, data: res[1]} ];
	// plot the trajectories initially
	plot[plotNum] = $.plot($("#placeholdert"), data, {
		series: {shadowSize: 0, lines: {show: true} },
		yaxis: { min: 0, max: 100 },
		xaxis: { min: 0, max: 100},
		grid: {show: true},
	});
	// update dynamically
	function update()
	{
		// update plots
		for (var i = 0; i < plotNum; ++ i)
		{
			var data = [getData(i+"v"), getData(i+"c"), getData(i+"s")];
			plot[i].setData(data);
			plot[i].draw();
		}
		// update trajectories
		var res = new Array();
		for (var i = 0; i < trajPlotNum; ++ i)
		{
			getData(i+"x");
			getData(i+"y");
			var len = dataset[i+"y"].data.length > dataset[i+"x"].data.length ? dataset[i+"x"].data.length : dataset[i+"y"].data.length;
			var init = len > trajLen ? len - trajLen : 0;
			res[i] = [];
			for (var j = init; j < len; ++ j)
				res[i].push([dataset[i+"x"].data[j], dataset[i+"y"].data[j]]);
		}
		plot[plotNum].setData([res[0], res[1]]);
		plot[plotNum].draw();
		setTimeout(update, 100);
	}
    update();
});
</script>
	</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Plots for Autolab</title>
    <script language="javascript" type="text/javascript" src="./flot/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="./flot/jquery.flot.js"></script>
 </head>
	<body>
	<h3 id="title" align="center">Plots for all robots</h3>
	<table border="1" style="width:100%;height:100%;">
		<tr>
			<td><div id="placeholdert" style="width:1200px;height:900px;"></div></td>
			<td>
				<p>cb01:
					<span id="r00">x</span>
					<span id="r01">y</span>
				</p>
				<p>cb18:
					<span id="r10">x</span>
					<span id="r11">y</span>
				</p>
				<p>pioneer01:
					<span id="r20">x</span>
					<span id="r21">y</span>
				</p>
			</td>
		</tr>
		<tr>
			<td><div id="placeholder0" style="width:1300px;height:220px;"></div></td>
			<td style="width:100px">
				<a href="dynamic-robot.html?robot=cb01">cb01</a>
				<p id="r02">voltage: </p>
				<p id="r03">current: </p>
				<p id="r04">speed: </p>
			</td>
		</tr>
		<tr>
			<td><div id="placeholder1" style="width:1300px;height:220px;"></div></td>
			<td style="width:100px">
				<a href="dynamic-robot.html?robot=cb02">cb02</a>
				<p id="r12">voltage: </p>
				<p id="r13">current: </p>
				<p id="r14">speed: </p>
			</td>
		</tr>
		<tr>
			<td><div id="placeholder2" style="width:1300px;height:220px;"></div></td>
			<td>
				<a href="dynamic-robot.html?robot=Pioneer01">Pioneer01</a>
				<p id="r22">voltage: </p>
				<p id="r23">current: </p>
				<p id="r24">speed: </p>
			</td>
		</tr>
	</table>
	<p id="debug">debug: </p>
<script type="text/javascript">
// by fzhan@Autolab
// dynamic figures for all the robots and trajectories.
$(function () {
	var totalPoints = 80, trajLen = 20, robotName = ["cb01", "cb18", "pioneer01"], label = ["valid", "x", "y", "speed", "voltage", "current"];
	var robotNum = 3, data_ret = [];
	for (var i = 0; i < robotNum * label.length; ++ i)
	{
		data_ret[i] = 0;
	}
    var dataset = {};
	// generate the list of datasets by robot names and labels
	for (var i = 0; i < robotNum; ++ i)
	{
		for (var j = 0; j < label.length; ++ j)
		{
			if (label[j] == "valid")
			{
				// set the default valid as true
				dataset[robotName[i] + label[j]] = {label: label[j], data: 1};
			} else
			{
				dataset[robotName[i] + label[j]] = {label: label[j], data: []};
			}
		}
	}
	// connect to Redis to retrieve data asynchronously
	function connectRedis()
	{
		var xmlhttp;
		if (window.XMLHttpRequest)
		{// code for IE7+, Firefox, Chrome, Opera, Safari
			xmlhttp=new XMLHttpRequest();
		}
		else
		{// code for IE6, IE5
			xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
		}
		xmlhttp.onreadystatechange=function()
		{
			if (xmlhttp.readyState==4 && xmlhttp.status==200)
			{
				var ret = xmlhttp.responseText.split(" ");
				//document.getElementById("debug").innerHTML = 'debug: ' + xmlhttp.responseText;
				for (var i = 0; i < ret.length - 1; ++ i)
				{
					data_ret[i] = parseFloat(ret[i]);
				}
			}
		}
		xmlhttp.open("GET","connectRedis.php",true);
		xmlhttp.send();
	}
	// get data from connectRedis()
    function updateData() {
		connectRedis();
		var cnt = -1;
		for (i in dataset)
		{
			if (i.substr(-5) == "valid")
			{
				continue;
			}
			++ cnt;
			var tmp = [];
			for (j in dataset[i].data)
			{
				tmp.push(dataset[i].data[j][1]);
			}
			if (tmp.length > 0)
			{
				tmp = tmp.slice(1);
			}
			var y = 0;
			while (tmp.length < totalPoints)
			{
				y = data_ret[cnt] * 100;
				//y = Math.floor(Math.random() * 100);
				tmp.push(y);
			}
			// add the number to the corresponding label
			document.getElementById("r"+ Math.floor(cnt/(label.length-1)) + cnt%(label.length-1)).innerHTML = dataset[i].label + ": " + y;
			// zip the generated y values with the x values
			var res = [];
			for (var j = 0; j < tmp.length; ++ j)
			{
				res.push([j + 1 - tmp.length, tmp[j]]);
			}
			dataset[i].data = res;
		}
    }
    // plot an array of plots
    updateData();
    var plot = new Array();
    for (var i = 0; i < robotNum; ++ i)
    {
		var data = [];
		for (var j = 3; j < label.length; ++ j)
		{
			data.push({label: dataset[robotName[i]+label[j]].label, data: dataset[robotName[i]+label[j]].data});
		}
		plot[i] = $.plot($("#placeholder"+i), data, {
			// drawing is faster without shadows
			series: {shadowSize: 0, lines: {show: true} },
			yaxis: { min: 0, max: 100 },
			xaxis: { min: -totalPoints + 1, max: 0},
			grid: {show: true},
		});
	}
	// get the data of the trajectories
	/*var res = new Array();
	for (var i = 0; i < robotNum; ++ i)
	{
		getData(i+"x");
		getData(i+"y");
		var len = dataset[i+"y"].data.length > dataset[i+"x"].data.length ? dataset[i+"x"].data.length : dataset[i+"y"].data.length;
		var init = len > trajLen ? len - trajLen : 0;
		res[i] = [];
		for (var j = init; j < len; ++ j)
			res[i].push([dataset[i+"x"].data[j], dataset[i+"y"].data[j]]);
	}
	var data = [{label: dataset["0y"].label, data: res[0]},
	{label: dataset["1y"].label, data: res[1]} ];
	// plot the trajectories initially
	plot[robotNum] = $.plot($("#placeholdert"), data, {
		series: {shadowSize: 0, lines: {show: true} },
		yaxis: { min: 0, max: 100 },
		xaxis: { min: 0, max: 100},
		grid: {show: true},
	});*/
	// update dynamically
	function update()
	{
		updateData();
		// update plots
		for (var i = 0; i < robotNum; ++ i)
		{
			var data = [];
			for (var j = 3; j < label.length; ++ j)
			{
				data.push( dataset[robotName[i]+label[j]].data );
			}
			plot[i].setData( data );
			plot[i].draw();
		}
		// update trajectories
		/*var res = new Array();
		for (var i = 0; i < robotNum; ++ i)
		{
			getData(i+"x");
			getData(i+"y");
			var len = dataset[i+"y"].data.length > dataset[i+"x"].data.length ? dataset[i+"x"].data.length : dataset[i+"y"].data.length;
			var init = len > trajLen ? len - trajLen : 0;
			res[i] = [];
			for (var j = init; j < len; ++ j)
				res[i].push([dataset[i+"x"].data[j], dataset[i+"y"].data[j]]);
		}
		plot[robotNum].setData([res[0], res[1]]);
		plot[robotNum].draw();*/
		setTimeout(update, 300);
	}
    update();
});
</script>
	</body>
</html>

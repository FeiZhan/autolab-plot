<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>plots for Autolab</title>
		<!--<link href="layout.css" rel="stylesheet" type="text/css">-->
		<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
		<script language="javascript" type="text/javascript" src="./flot/jquery.js"></script>
		<script language="javascript" type="text/javascript" src="./flot/jquery.flot.js"></script>
		<script language="javascript" type="text/javascript" src="./flot/jquery.flot.crosshair.js"></script>
	</head>
	<body>
		<h1 align='center'>plots for Autolab</h1>
		<div id="placeholder" style="width:600px;height:300px;"></div>
		<p id="choices">Show:</p>
		<p id="hoverdata"></p>
		<script type="text/javascript">
var plot;
$(function ()
{
    var d1 = [];
    for (var i = 0; i < 14; i += 0.5)
        d1.push([i, Math.sin(i)]);
    var d2 = [[0, 3], [4, 8], [8, 5], [9, 13]];
    // a null signifies separate line segments
    var d3 = [[0, 12], [7, 12], [7, 2.5], [12, 2.5]];
    var datasets = 
    {
		"voltage":
		{
			label: "voltage =",
			data: d1
		},
		"current":
		{
			label: "current =",
			data: d2
		},
		"energy":
		{
			label: "energy =",
			data: d3
		}
	};
	var option = 
	{
		series: {
			lines: {show: true},
			points: {show: true}
		},
		crosshair: {mode: "x"},
		grid: {
			show: true,
			hoverable: true,
			autoHighlight: false
		}
	};
    // hard-code color indices to prevent them from shifting as data are turned on/off
    var i = 0;
    $.each(datasets, function(key, val) {
        val.color = i;
        ++i;
    });
    // insert checkboxes 
    var choiceContainer = $("#choices");
    $.each(datasets, function(key, val) {
        choiceContainer.append('<br/><input type="checkbox" name="' + key +
                               '" checked="checked" id="id' + key + '">' +
                               '<label for="id' + key + '">'
                                + val.label.replace(/=.*/, "") + '</label>');
    });
    choiceContainer.find("input").click(plotAccordingToChoices);

	function plotAccordingToChoices() {
        var data = [];
        choiceContainer.find("input:checked").each(function () {
            var key = $(this).attr("name");
            if (key && datasets[key])
                data.push(datasets[key]);
        });
        if (data.length > 0)
		{
            plot = $.plot($("#placeholder"), data, option);
			var legends = $("#placeholder .legendLabel");
			legends.each(function () {
				// fix the widths so they don't jump around
				$(this).css('width', $(this).width());
			});
			var updateLegendTimeout = null;
			var latestPosition = null;
			function updateLegend() {
				updateLegendTimeout = null;
				var pos = latestPosition;
				var axes = plot.getAxes();
				if (pos.x < axes.xaxis.min || pos.x > axes.xaxis.max ||
					pos.y < axes.yaxis.min || pos.y > axes.yaxis.max)
					return;
				var i, j, dataset = plot.getData();
				for (i = 0; i < dataset.length; ++i) {
					var series = dataset[i];
					// find the nearest points, x-wise
					for (j = 0; j < series.data.length; ++j)
						if (series.data[j][0] > pos.x)
							break;
					// now interpolate
					var y, p1 = series.data[j - 1], p2 = series.data[j];
					if (p1 == null)
						y = p2[1];
					else if (p2 == null)
						y = p1[1];
					else
						y = p1[1] + (p2[1] - p1[1]) * (pos.x - p1[0]) / (p2[0] - p1[0]);

					legends.eq(i).text(series.label.replace(/=.*/, "= " + y.toFixed(2)));
				}
			}
			$("#placeholder").bind("plothover", function (event, pos, item) {
				latestPosition = pos;
				if (!updateLegendTimeout)
					updateLegendTimeout = setTimeout(updateLegend, 50);
			});
		}
    }
    plotAccordingToChoices();
});
		</script>
	</body>
</html>
